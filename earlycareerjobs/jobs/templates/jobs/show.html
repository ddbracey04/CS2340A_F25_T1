{% extends 'base.html' %}
{% block content %}
{% load static %}

<div class="container mt-5">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <a href="{% url 'jobs.index' %}" class="btn btn-outline-secondary btn-sm mb-3">
        <i class="bi bi-arrow-left"></i> Back to Jobs
      </a>
    </div>
  </div>

  <div class="row">
    <!-- Main Content -->
    <div class="col-lg-8 mb-4">
      <!-- Job Header Card -->
      <div class="card shadow-sm mb-4">
        <div class="job-image-wrapper">
          {% if template_data.job.image %}
            <img src="{{ template_data.job.image.url }}" class="card-img-top" alt="{{ template_data.job.title }}" style="object-fit: contain;">
          {% else %}
            <div class="job-image-placeholder d-flex align-items-center justify-content-center">
              <i class="bi bi-image" aria-hidden="true"></i>
            </div>
          {% endif %}
          {% if forms.image_form and template_data.can_edit %}
            <button class="job-image-edit-btn btn btn-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#edit-image-form" aria-expanded="false" aria-controls="edit-image-form">
              <i class="bi bi-pencil"></i> Edit photo
            </button>
          {% endif %}
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h2 class="card-title mb-2 d-flex align-items-center gap-2">
                <span>{{ template_data.job.title }}</span>
                {% if forms.title_form and template_data.can_edit %}
                  <button class="btn btn-link btn-sm edit-inline-btn" type="button" data-bs-toggle="collapse" data-bs-target="#edit-title-form" aria-expanded="false" aria-controls="edit-title-form">
                    <i class="bi bi-pencil"></i>
                    <span class="visually-hidden">Edit title</span>
                  </button>
                {% endif %}
              </h2>
              {% if template_data.job.company %}
              <p class="text-muted mb-0">
                <i class="bi bi-building"></i> {{ template_data.job.company }}
              </p>
              {% endif %}
            </div>
            <div class="d-flex flex-column flex-sm-row align-items-sm-start justify-content-end gap-2">
              {% if template_data.can_edit or user.is_admin %}
                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal">
                  <i class="bi bi-trash"></i> Delete
                </button>
              {% endif %}
            </div>
          </div>

          {% if forms.title_form and template_data.can_edit %}
          <div class="collapse mt-2" id="edit-title-form">
            <form method="post" action="{% url 'jobs.update_field' id=template_data.job.id field='title' %}" class="card card-body border-0 shadow-sm">
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label fw-semibold" for="{{ forms.title_form.title.id_for_label }}">Job title</label>
                {{ forms.title_form.title }}
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="bi bi-check-lg"></i> Save
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#edit-title-form">
                  Cancel
                </button>
              </div>
            </form>
          </div>
          {% endif %}

          {% if forms.image_form and template_data.can_edit %}
          <div class="collapse mt-2" id="edit-image-form">
            <form method="post" action="{% url 'jobs.update_field' id=template_data.job.id field='image' %}" enctype="multipart/form-data" class="card card-body border-0 shadow-sm">
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label fw-semibold" for="{{ forms.image_form.image.id_for_label }}">Job image</label>
                {{ forms.image_form.image }}
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="bi bi-cloud-arrow-up"></i> Upload
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#edit-image-form">
                  Cancel
                </button>
              </div>
            </form>
          </div>
          {% endif %}

          <!-- Job Description -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">
                <i class="bi bi-file-text"></i> Job Description
              </h5>
              {% if forms.description_form and template_data.can_edit %}
                <button class="btn btn-link btn-sm edit-inline-btn" type="button" data-bs-toggle="collapse" data-bs-target="#edit-description-form" aria-expanded="false" aria-controls="edit-description-form">
                  <i class="bi bi-pencil"></i> Edit
                </button>
              {% endif %}
            </div>
            <p class="text-secondary">{{ template_data.job.description }}</p>
            {% if forms.description_form and template_data.can_edit %}
            <div class="collapse" id="edit-description-form">
              <form method="post" action="{% url 'jobs.update_field' id=template_data.job.id field='description' %}" class="card card-body border-0 shadow-sm">
                {% csrf_token %}
                <div class="mb-3">
                  <label class="form-label fw-semibold" for="{{ forms.description_form.description.id_for_label }}">Description</label>
                  {{ forms.description_form.description }}
                </div>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-check-lg"></i> Save
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#edit-description-form">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
            {% endif %}
          </div>

          <!-- Required Skills -->
          {% if template_data.job.skill_list or forms.skills_form %}
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">
                <i class="bi bi-gear"></i> Required Skills
              </h5>
              {% if forms.skills_form and template_data.can_edit %}
                <button class="btn btn-link btn-sm edit-inline-btn" type="button" data-bs-toggle="collapse" data-bs-target="#edit-skills-form" aria-expanded="false" aria-controls="edit-skills-form">
                  <i class="bi bi-pencil"></i> Edit
                </button>
              {% endif %}
            </div>
            {% if template_data.job.skill_list %}
              <div class="skill-badge-group">
                {% for skill in template_data.job.skill_list %}
                  <span class="skill-badge">{{ skill }}</span>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted fst-italic mb-0">No skills listed yet.</p>
            {% endif %}
            {% if forms.skills_form and template_data.can_edit %}
            <div class="collapse mt-2" id="edit-skills-form">
              <form method="post" action="{% url 'jobs.update_field' id=template_data.job.id field='skills' %}" class="card card-body border-0 shadow-sm">
                {% csrf_token %}
                <div class="mb-3">
                  <label class="form-label fw-semibold" for="{{ forms.skills_form.skills.id_for_label }}">Skills</label>
                  {{ forms.skills_form.skills }}
                  <small class="text-muted">Separate skills with commas.</small>
                </div>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-check-lg"></i> Save
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#edit-skills-form">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Job Details Sidebar Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-info-circle"></i> Job Details
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            {% if template_data.job.city or template_data.job.state or template_data.job.country or forms.location_form %}
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-geo-alt"></i> Location
                  </p>
                  <p class="mb-0">
                    {% if template_data.job.city or template_data.job.state or template_data.job.country %}
                      {{ template_data.job.city }}{% if template_data.job.state %}, {{ template_data.job.state }}{% endif %}{% if template_data.job.country %}, {{ template_data.job.country }}{% endif %}
                    {% else %}
                      <span class="text-muted fst-italic">Not specified</span>
                    {% endif %}
                  </p>
                </div>
                {% if forms.location_form and template_data.can_edit %}
                  <button class="btn btn-link btn-sm edit-inline-btn" type="button" data-bs-toggle="collapse" data-bs-target="#edit-location-form" aria-expanded="false" aria-controls="edit-location-form">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                {% endif %}
              </div>
            </div>
            {% endif %}

            {% if template_data.job.work_style or forms.work_style_form %}
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-laptop"></i> Work Style
                  </p>
                  <p class="mb-0">
                    {% if template_data.job.work_style %}
                      {{ template_data.job.get_work_style_display }}
                    {% else %}
                      <span class="text-muted fst-italic">Not specified</span>
                    {% endif %}
                  </p>
                </div>
                {% if forms.work_style_form and template_data.can_edit %}
                  <button class="btn btn-link btn-sm edit-inline-btn" type="button" data-bs-toggle="collapse" data-bs-target="#edit-workstyle-form" aria-expanded="false" aria-controls="edit-workstyle-form">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                {% endif %}
              </div>
            </div>
            {% endif %}

            {% if template_data.job.salary_min or template_data.job.salary_max or forms.salary_form %}
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-currency-dollar"></i> Salary Range
                  </p>
                  <p class="mb-0">
                    {% if template_data.job.salary_min and template_data.job.salary_max %}
                      ${{ template_data.job.salary_min|floatformat:2 }} - ${{ template_data.job.salary_max|floatformat:2 }}
                    {% elif template_data.job.salary_min %}
                      From ${{ template_data.job.salary_min|floatformat:2 }}
                    {% elif template_data.job.salary_max %}
                      Up to ${{ template_data.job.salary_max|floatformat:2 }}
                    {% else %}
                      <span class="text-muted fst-italic">Not specified</span>
                    {% endif %}
                  </p>
                </div>
                {% if forms.salary_form and template_data.can_edit %}
                  <button class="btn btn-link btn-sm edit-inline-btn" type="button" data-bs-toggle="collapse" data-bs-target="#edit-salary-form" aria-expanded="false" aria-controls="edit-salary-form">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <div class="col-12">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="mb-1 text-muted small">
                    <i class="bi bi-globe"></i> Visa Sponsorship
                  </p>
                  <p class="mb-0">
                    {% if template_data.job.visa_sponsorship %}
                      <span class="badge bg-success">Available</span>
                    {% else %}
                      <span class="badge bg-secondary">Not Available</span>
                    {% endif %}
                  </p>
                </div>
                {% if forms.visa_form and template_data.can_edit %}
                  <button class="btn btn-link btn-sm edit-inline-btn" type="button" data-bs-toggle="collapse" data-bs-target="#edit-visa-form" aria-expanded="false" aria-controls="edit-visa-form">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                {% endif %}
              </div>
            </div>
          </div>

          {% if forms.location_form and template_data.can_edit %}
          <div class="collapse mt-3" id="edit-location-form">
            <form method="post" action="{% url 'jobs.update_field' id=template_data.job.id field='location' %}" class="card card-body border-0 shadow-sm">
              {% csrf_token %}
              <div class="row g-2">
                <div class="col-md-4">
                  <label class="form-label fw-semibold" for="{{ forms.location_form.city.id_for_label }}">City</label>
                  {{ forms.location_form.city }}
                </div>
                <div class="col-md-4">
                  <label class="form-label fw-semibold" for="{{ forms.location_form.state.id_for_label }}">State</label>
                  {{ forms.location_form.state }}
                </div>
                <div class="col-md-4">
                  <label class="form-label fw-semibold" for="{{ forms.location_form.country.id_for_label }}">Country</label>
                  {{ forms.location_form.country }}
                </div>
              </div>
              <div class="d-flex gap-2 mt-3">
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="bi bi-check-lg"></i> Save
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#edit-location-form">
                  Cancel
                </button>
              </div>
            </form>
          </div>
          {% endif %}

          {% if forms.salary_form and template_data.can_edit %}
          <div class="collapse mt-3" id="edit-salary-form">
            <form method="post" action="{% url 'jobs.update_field' id=template_data.job.id field='salary' %}" class="card card-body border-0 shadow-sm">
              {% csrf_token %}
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ forms.salary_form.salary_min.id_for_label }}">Minimum</label>
                  {{ forms.salary_form.salary_min }}
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ forms.salary_form.salary_max.id_for_label }}">Maximum</label>
                  {{ forms.salary_form.salary_max }}
                </div>
              </div>
              <div class="d-flex gap-2 mt-3">
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="bi bi-check-lg"></i> Save
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#edit-salary-form">
                  Cancel
                </button>
              </div>
            </form>
          </div>
          {% endif %}

          {% if forms.work_style_form and template_data.can_edit %}
          <div class="collapse mt-3" id="edit-workstyle-form">
            <form method="post" action="{% url 'jobs.update_field' id=template_data.job.id field='work_style' %}" class="card card-body border-0 shadow-sm">
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label fw-semibold" for="{{ forms.work_style_form.work_style.id_for_label }}">Work style</label>
                {{ forms.work_style_form.work_style }}
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="bi bi-check-lg"></i> Save
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#edit-workstyle-form">
                  Cancel
                </button>
              </div>
            </form>
          </div>
          {% endif %}

          {% if forms.visa_form and template_data.can_edit %}
          <div class="collapse mt-3" id="edit-visa-form">
            <form method="post" action="{% url 'jobs.update_field' id=template_data.job.id field='visa' %}" class="card card-body border-0 shadow-sm">
              {% csrf_token %}
              <div class="form-check mb-3">
                {{ forms.visa_form.visa_sponsorship }}
                <label class="form-check-label" for="{{ forms.visa_form.visa_sponsorship.id_for_label }}">
                  Offer visa sponsorship
                </label>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="bi bi-check-lg"></i> Save
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#edit-visa-form">
                  Cancel
                </button>
              </div>
            </form>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Application Form or Status (for Job Seekers) -->
      {% if user.is_authenticated %}
        {% if user.is_job_seeker %}
          {% if not template_data.has_applied %}
            <!-- Application Form -->
            <div class="card shadow-sm mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                  <i class="bi bi-file-earmark-text"></i> Apply for This Position
                </h5>
              </div>
              <div class="card-body">
                <form method="POST" action="{% url 'jobs.start_application' id=template_data.job.id %}">
                  {% csrf_token %}
                  <div class="mb-3">
                    <label for="user_note" class="form-label fw-bold">
                      Tell us why you're a great fit:
                    </label>
                    <textarea 
                      name="user_note" 
                      id="user_note" 
                      rows="5" 
                      class="form-control" 
                      placeholder="Share your relevant experience, skills, and why you're interested in this role..."
                      required></textarea>
                    <div class="form-text">
                      Tip: Highlight how your skills match the job requirements above.
                    </div>
                  </div>
                  <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                      <i class="bi bi-send"></i> Submit Application
                    </button>
                  </div>
                </form>
              </div>
            </div>
          {% else %}
            <!-- Already Applied -->
            <div class="alert alert-success shadow-sm mb-4" role="alert">
              <i class="bi bi-check-circle-fill"></i> 
              <strong>Application Submitted!</strong> You have already applied to this job. Good luck!
            </div>
          {% endif %}
        {% endif %}

        <!-- Recommended Candidates (for Recruiters/Admins) -->
        {% if template_data.can_edit %}
          {% if template_data.recommended_candidates %}
          <div class="alert alert-info shadow-sm mb-4" role="alert">
            <button type="button" class="btn-close float-end" aria-label="Close" onclick="this.parentElement.style.display='none'"></button>
            <h5 class="alert-heading">
              <i class="bi bi-stars"></i> Recommended Candidates
            </h5>
            <p class="mb-3">These candidates have skills that match your job requirements:</p>
            <div class="d-flex overflow-auto gap-3 py-2" style="-webkit-overflow-scrolling: touch;">
              {% for rec in template_data.recommended_candidates %}
              <div class="card hover-shadow" style="min-width: 300px; flex: 0 0 auto;">
                <div class="card-body">
                  <h6 class="card-title mb-1">
                    {{ rec.user.get_full_name|default:rec.user.username }}
                  </h6>
                  <p class="text-muted small mb-2">
                    <i class="bi bi-calendar"></i> Applied: {{ rec.application.date|date:"M d, Y" }}
                  </p>

                  {% if request.user.is_recruiter and rec.user.home_profile.privacy.is_profile_visible == False or request.user.is_recruiter and rec.user.home_profile.privacy.show_skills == False %}
                  {% elif rec.common_skills %}
                  <div class="mb-2">
                    <small class="text-muted">Matching Skills:</small>
                    <div class="skill-badge-group mt-1">
                      {% for skill in rec.common_skills %}
                      <span class="skill-badge-sm">{{ skill }}</span>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}
                  {% if rec.application.user_note %}
                  <p class="small text-secondary mb-2">
                    "{{ rec.application.user_note|truncatewords:20 }}"
                  </p>
                  {% endif %}


                  <div class="btn-group" role="group" style="padding-bottom: 3px;">
                    {% if rec.application.status == "APPLIED" %}
                    <a href="{% url 'jobs.update_application_status' application_id=rec.application.id new_status='APPLIED' %}" class="btn btn-sm earlycareerjobs-btn">
                    {% else %}
                    <a href="{% url 'jobs.update_application_status' application_id=rec.application.id new_status='APPLIED' %}" class="btn btn-sm earlycareerjobs-btn-outline">
                    {% endif %}
                      <i class="bi bi-person"></i> Applied
                    </a>

                    {% if rec.application.status == "REVIEW" %}
                    <a href="{% url 'jobs.update_application_status' application_id=rec.application.id new_status='REVIEW' %}" class="btn btn-sm earlycareerjobs-btn">
                    {% else %}
                    <a href="{% url 'jobs.update_application_status' application_id=rec.application.id new_status='REVIEW' %}" class="btn btn-sm earlycareerjobs-btn-outline">
                    {% endif %}
                      <i class="bi bi-person"></i> Under Review
                    </a>

                    {% if rec.application.status == "INTERVIEW" %}
                    <a href="{% url 'jobs.update_application_status' application_id=rec.application.id new_status='INTERVIEW' %}" class="btn btn-sm earlycareerjobs-btn">
                    {% else %}
                    <a href="{% url 'jobs.update_application_status' application_id=rec.application.id new_status='INTERVIEW' %}" class="btn btn-sm earlycareerjobs-btn-outline">
                    {% endif %}
                      <i class="bi bi-person"></i> Interview
                    </a>

                    {% if rec.application.status == "OFFER" %}
                    <a href="{% url 'jobs.update_application_status' application_id=rec.application.id new_status='OFFER' %}" class="btn btn-sm earlycareerjobs-btn">
                    {% else %}
                    <a href="{% url 'jobs.update_application_status' application_id=rec.application.id new_status='OFFER' %}" class="btn btn-sm earlycareerjobs-btn-outline">
                    {% endif %}
                      <i class="bi bi-person"></i> Offer
                    </a>

                    {% if rec.application.status == "CLOSED" %}
                    <a href="{% url 'jobs.update_application_status' application_id=rec.application.id new_status='CLOSED' %}" class="btn btn-sm earlycareerjobs-btn">
                    {% else %}
                    <a href="{% url 'jobs.update_application_status' application_id=rec.application.id new_status='CLOSED' %}" class="btn btn-sm earlycareerjobs-btn-outline">
                    {% endif %}
                      <i class="bi bi-person"></i> Closed
                    </a>
                  </div>

                  <br>

                  {% if request.user.is_recruiter and rec.user.home_profile.privacy.is_profile_visible == False %}
                  {% else %}
                    <a href="{% url 'profile.view' username=rec.user.username %}" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-person"></i> View Profile
                    </a>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- All Applicants Section -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-people"></i> Applicants
                <span class="badge bg-secondary">{{ template_data.applications|length }}</span>
              </h5>
              {% if user.is_authenticated and user.is_recruiter %}
              <a href="{% url 'candidates.search' %}?job_id={{ template_data.job.id }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-search"></i> Search Candidates for This Job
              </a>
              {% endif %}
            </div>
            <div class="card-body">
              {% if template_data.can_edit %}
                {% if template_data.kanban_total %}
                <div class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-3 g-lg-4 mb-4">
                  <div class="col">
                    <div class="tracker-summary-card">
                      <p class="summary-label text-uppercase">Total</p>
                      <p class="summary-value" data-summary-total>{{ template_data.kanban_total }}</p>
                    </div>
                  </div>
                  {% for column in template_data.kanban_columns %}
                  <div class="col">
                    <div class="tracker-summary-card tracker-summary-card--{{ column.key|lower }}">
                      <p class="summary-label text-uppercase">{{ column.label }}</p>
                      <p class="summary-value" data-summary-status="{{ column.key }}">{{ column.count }}</p>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                <div class="kanban-columns px-2 pb-4">
                  <div class="kanban-columns__inner">
                    {% for column in template_data.kanban_columns %}
                    <section class="kanban-column" data-status="{{ column.key }}">
                      <header class="kanban-column__header">
                        <div class="kanban-column__titles">
                          <span class="kanban-column__title">{{ column.label }}</span>
                          <small class="kanban-column__subtitle text-muted" data-column-count="{{ column.key }}">{{ column.count }} {% if column.count == 1 %}applicant{% else %}applicants{% endif %}</small>
                        </div>
                        <span class="kanban-column__count badge rounded-pill" data-status-count="{{ column.key }}">{{ column.count }}</span>
                      </header>
                      <div class="kanban-column__body" data-column-body="{{ column.key }}">
                        <div class="kanban-column__empty text-muted"{% if column.applications %} style="display: none;"{% endif %}>
                          <p class="mb-0">Drop applicants here to move them into {{ column.label|lower }}.</p>
                        </div>
                        {% for application in column.applications %}
                        <article
                          class="kanban-card"
                          draggable="true"
                          data-application-id="{{ application.id }}"
                          data-update-url="{% url 'jobs.update_application_status_ajax' application.id %}"
                          data-current-status="{{ application.status }}"
                        >
                          <div class="kanban-card__header">
                            <h3 class="kanban-card__title h6 mb-0">
                              {{ application.user.get_full_name|default:application.user.username }}
                            </h3>
                            <div class="kanban-card__company text-uppercase text-muted fw-semibold">
                              Applied {{ application.date|date:"M d, Y" }}
                            </div>
                          </div>
                          <ul class="kanban-card__meta list-unstyled mb-3">
                            <li>
                              <i class="bi bi-envelope me-1"></i>
                              {{ application.user.email }}
                            </li>
                            {% if application.user.profile.phone_number %}
                            <li>
                              <i class="bi bi-telephone me-1"></i>
                              {{ application.user.profile.phone_number }}
                            </li>
                            {% endif %}
                          </ul>
                          {% if application.user_note %}
                          <div class="kanban-card__note">
                            <span class="kanban-card__note-label text-uppercase">Candidate message</span>
                            <p class="kanban-card__note-text mb-0">{{ application.user_note|truncatewords:22 }}</p>
                          </div>
                          {% endif %}
                          <div class="kanban-card__actions">
                            <div class="d-grid gap-2">
                              {% if request.user.is_recruiter and application.user.home_profile.privacy.is_profile_visible == False %}
                                <span class="text-muted small">Profile hidden by candidate.</span>
                              {% else %}
                                <a href="{% url 'profile.view' username=application.user.username %}" class="btn btn-sm earlycareerjobs-btn-outline">
                                  View Profile
                                </a>
                              {% endif %}
                              {% if request.user.is_admin %}
                                <a href="{% url 'jobs.edit_applicant' job_id=template_data.job.id app_id=application.id %}" class="btn btn-sm btn-outline-warning">
                                  Edit Notes
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAppModal{{ application.id }}">
                                  Remove
                                </button>
                              {% endif %}
                            </div>
                          </div>
                        </article>
                        {% endfor %}
                      </div>
                    </section>
                    {% endfor %}
                  </div>
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                  <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                  <p class="mt-3">No applications yet. Share this job posting to attract candidates!</p>
                </div>
                {% endif %}
              {% else %}
                {% if template_data.applications %}
                <div class="list-group list-group-flush">
                  {% for application in template_data.applications %}
                  <div class="list-group-item hover-shadow mb-2 rounded">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <h6 class="mb-1">
                          {{ application.user.get_full_name|default:application.user.username }}
                        </h6>
                        <small class="text-muted">
                          <i class="bi bi-calendar"></i> {{ application.date|date:"M d, Y" }}
                        </small>
                      </div>
                      <span class="badge 
                        {% if application.status == 'APPLIED' %}active_application_status
                        {% elif application.status == 'REVIEW' %}review_application_status
                        {% elif application.status == 'INTERVIEW' %}interview_application_status
                        {% elif application.status == 'OFFER' %}offer_application_status
                        {% elif application.status == 'CLOSED' %}closed_application_status
                        {% else %}error_application_status{% endif %}">
                        {{ application.get_status_display }}
                      </span>
                    </div>
                    {% if application.user_note %}
                    <p class="mb-0 text-secondary small">"{{ application.user_note|truncatewords:25 }}"</p>
                    {% endif %}
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                  <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                  <p class="mt-3">No applications yet. Share this job posting to attract candidates!</p>
                </div>
                {% endif %}
              {% endif %}
            </div>
          </div>
        {% if template_data.can_edit and user.is_admin %}
          {% for application in template_data.applications %}
          <div class="modal fade" id="deleteAppModal{{ application.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Confirm Removal</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  Are you sure you want to remove {{ application.user.username }}'s application?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <form method="post" action="{% url 'jobs.delete_applicant' job_id=template_data.job.id app_id=application.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Remove</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        {% endif %}
        {% endif %}
      {% endif %}
    </div>
    <!-- <div class="col-md-6 mx-auto mb-3 text-center">
      {% if template_data.job.image.url != '' %}
        <img src="{{ template_data.job.image.url }}" class="rounded img-card-400" />
      {% endif %}
      
    </div> -->
  </div>
</div>

<!-- Delete Job Modal -->
{% if template_data.can_edit or user.is_admin %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this job posting? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{% url 'jobs.delete' id=template_data.job.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Delete Job</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if template_data.can_edit %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const draggableCards = document.querySelectorAll('.kanban-card');
  const columnBodies = document.querySelectorAll('[data-column-body]');
  if (!draggableCards.length || !columnBodies.length) {
    return;
  }

  const summaryTotal = document.querySelector('[data-summary-total]');
  const summaryByStatus = document.querySelectorAll('[data-summary-status]');
  const columnCountLabels = document.querySelectorAll('[data-column-count]');
  const statusBadges = document.querySelectorAll('[data-status-count]');

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function toggleEmptyState(body) {
    const emptyState = body.querySelector('.kanban-column__empty');
    if (!emptyState) {
      return;
    }
    const hasCards = body.querySelectorAll('.kanban-card').length > 0;
    emptyState.style.display = hasCards ? 'none' : 'block';
  }

  function formatCountLabel(count) {
    return count + ' ' + (count === 1 ? 'applicant' : 'applicants');
  }

  function applyStats(stats, total) {
    if (summaryTotal) {
      summaryTotal.textContent = total;
    }

    summaryByStatus.forEach(summary => {
      const status = summary.getAttribute('data-summary-status');
      const count = stats[status] || 0;
      summary.textContent = count;
    });

    statusBadges.forEach(badge => {
      const status = badge.getAttribute('data-status-count');
      const count = stats[status] || 0;
      badge.textContent = count;
    });

    columnCountLabels.forEach(label => {
      const status = label.getAttribute('data-column-count');
      const count = stats[status] || 0;
      label.textContent = formatCountLabel(count);
    });
  }

  function attachDragEvents(card) {
    card.addEventListener('dragstart', (event) => {
      card.classList.add('is-dragging');
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', card.dataset.applicationId);
    });

    card.addEventListener('dragend', () => {
      card.classList.remove('is-dragging');
    });
  }

  draggableCards.forEach(attachDragEvents);

  columnBodies.forEach(body => {
    body.addEventListener('dragover', (event) => {
      event.preventDefault();
      body.classList.add('is-drag-over');
      event.dataTransfer.dropEffect = 'move';
    });

    body.addEventListener('dragleave', () => {
      body.classList.remove('is-drag-over');
    });

    body.addEventListener('drop', (event) => {
      event.preventDefault();
      body.classList.remove('is-drag-over');

      const applicationId = event.dataTransfer.getData('text/plain');
      if (!applicationId) {
        return;
      }

      const card = document.querySelector('.kanban-card.is-dragging') || document.querySelector(`.kanban-card[data-application-id="${applicationId}"]`);
      if (!card) {
        return;
      }

      const targetStatus = body.getAttribute('data-column-body');
      const currentStatus = card.dataset.currentStatus;
      if (!targetStatus || targetStatus === currentStatus) {
        return;
      }

      const originBody = document.querySelector(`[data-column-body="${currentStatus}"]`);
      const updateUrl = card.getAttribute('data-update-url');

      body.appendChild(card);
      toggleEmptyState(body);
      if (originBody) {
        toggleEmptyState(originBody);
      }

      fetch(updateUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ status: targetStatus }),
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Request failed');
          }
          return response.json();
        })
        .then(data => {
          if (!data.success) {
            throw new Error(data.error || 'Unable to update application status.');
          }
          card.dataset.currentStatus = data.status;
          applyStats(data.stats || {}, data.total_applications || 0);
        })
        .catch(error => {
          if (originBody) {
            originBody.appendChild(card);
            toggleEmptyState(originBody);
          }
          toggleEmptyState(body);
          console.error(error);
          alert('Unable to update the application status right now. Please try again.');
        });
    });
  });
});
</script>
{% endif %}

<style>
.hover-shadow {
  transition: box-shadow 0.3s ease;
}

.hover-shadow:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.skill-badge-group {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.skill-badge {
  display: inline-block;
  padding: 0.4rem 0.8rem;
  background-color: #5D61EA;
  color: white;
  border-radius: 1rem;
  font-size: 0.85rem;
  font-weight: 500;
}

.skill-badge-sm {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  background-color: #e7e7ff;
  color: #5D61EA;
  border-radius: 0.75rem;
  font-size: 0.75rem;
  font-weight: 500;
}
</style>

{% endblock content %}
