{% extends 'base.html' %}
{% load static %}
{% block content %}
<section class="py-4">
  <div class="container">
    <div class="row g-4">
      <div class="col-12 col-lg-4 col-xl-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <h4 class="h5 mb-3">Search candidates</h4>
            <form method="get" id="searchForm" novalidate>
              <!-- Job Selection (if recruiter has multiple jobs) -->
              {% if recruiter_jobs %}
              <div class="mb-3">
                <label class="form-label">Select Job (optional)</label>
                <select name="job_id" class="form-control" onchange="this.form.submit()">
                  <option value="">All candidates</option>
                  {% for rjob in recruiter_jobs %}
                    <option value="{{ rjob.id }}" {% if job and job.id == rjob.id %}selected{% endif %}>
                      {{ rjob.title }} ({{ rjob.applicant_count }} applicant{{ rjob.applicant_count|pluralize }})
                    </option>
                  {% endfor %}
                </select>
                <small class="text-muted">Select a job to see its candidates.</small>
              </div>
              {% endif %}
              
              <!-- Skills Bubble Input -->
              <div class="mb-3">
                <label class="form-label">Skills</label>
                <input list="skillSuggestions" class="form-control datalist-no-arrow" placeholder="Enter or Select Skills" id="skillInput" autocomplete="off" style="width: 100%;">
                <datalist id="skillSuggestions">
                  {% for skill in all_skills %}
                    <option value="{{ skill }}">
                  {% endfor %}
                </datalist>
                
                <!-- Skills Chips -->
                <div id="skillsChips" class="mt-2 d-flex flex-wrap gap-2">
                  {% for skill in active_skills %}
                    <span class="badge bg-primary d-flex align-items-center gap-2 skill-chip">
                      {{ skill }}
                      <input type="hidden" name="skill" value="{{ skill }}">
                      <span class="remove-chip" onclick="removeSkill(this)" 
                            style="cursor: pointer; font-size: 1.2rem; font-weight: 300; opacity: 0.8; transition: opacity 0.2s;" 
                            onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">×</span>
                    </span>
                  {% endfor %}
                </div>
              </div>
              
              <div class="mb-3">
                {{ form.skills_mode.label_tag }}
                {{ form.skills_mode }}
              </div>
              
              <div class="mb-3">
                {{ form.experience.label_tag }}
                {{ form.experience }}
              </div>
              
              <div class="mb-3">
                {{ form.location.label_tag }}
                {{ form.location }}
              </div>
              
              <div class="mb-3">
                {{ form.distance.label_tag }}
                {{ form.distance }}
              </div>
              
              <div class="mb-3">
                {{ form.work_style.label_tag }}
                {{ form.work_style }}
              </div>
              <div class="mb-3">
                {{ form.sort_by.label_tag }}
                {{ form.sort_by }}
              </div>
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary" style="background-color: #5D61EA; border-color: #5D61EA;">Search</button>
                <a href="{% url 'candidates.search' %}" class="btn btn-outline-secondary">Reset</a>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-8 col-xl-9">
        {% if job %}
          <div class="alert alert-info mb-4">
            <h5 class="mb-2"><i class="bi bi-briefcase"></i> Searching candidates for: {{ job.title }}</h5>
            <p class="mb-1"><strong>Location:</strong> 
              {% if job.city %}{{ job.city }}{% endif %}{% if job.state %}{% if job.city %}, {% endif %}{{ job.state }}{% endif %}{% if job.country %}{% if job.city or job.state %}, {% endif %}{{ job.country }}{% endif %}
            </p>
            <p class="mb-0"><small class="text-muted">Distances shown are from the job location to each candidate.</small></p>
          </div>
        {% endif %}
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <p class="text-uppercase small fw-semibold text-muted mb-1">Results</p>
            <h2 class="h4 mb-0">{{ result_count }} {% if result_count == 1 %}candidate{% else %}candidates{% endif %} found</h2>
          </div>
        </div>
        {% if profiles %}
          <div class="row g-4">
            {% for profile in profiles %}
              <div class="col-12">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
                      <div>
                        <h3 class="h5 mb-1">
                          <a href="{% url 'profile.view' username=profile.user.username %}" class="text-decoration-none text-dark">
                            {{ profile.user.get_full_name|default:profile.user.username }}
                          </a>
                        </h3>
                        {% if profile.headline %}
                          <p class="mb-2 text-muted">{{ profile.headline }}</p>
                        {% endif %}
                        <div class="mb-2">
                          {% if profile.city or profile.state or profile.country %}
                            <span class="badge text-bg-light border">
                              <i class="bi bi-geo-alt"></i>
                              {% if profile.city %}{{ profile.city }}{% endif %}{% if profile.state %}{% if profile.city %}, {% endif %}{{ profile.state }}{% endif %}{% if profile.country %}{% if profile.city or profile.state %}, {% endif %}{{ profile.country }}{% endif %}
                            </span>
                          {% endif %}
                          {% if profile.distance is not None %}
                            <span class="badge bg-info text-dark">{{ profile.distance }} miles away</span>
                          {% endif %}
                          {% if profile.work_style_preference %}
                            <span class="badge text-bg-light border">{{ profile.get_work_style_preference_display }}</span>
                          {% endif %}
                        </div>
                      </div>
                      <div class="text-md-end">
                        <a href="{% url 'profile.view' username=profile.user.username %}" class="btn btn-outline-primary">
                          View profile
                        </a>
                      </div>
                    </div>
                    {% if profile.skill_list %}
                      <div class="mt-3">
                        <p class="small text-uppercase text-muted fw-semibold mb-2">Skills</p>
                        <div class="skill-badge-group">
                          {% for skill in profile.skill_list %}
                            <span class="skill-badge">{{ skill }}</span>
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}
                    {% if profile.experience %}
                      <div class="mt-3">
                        <p class="small text-uppercase text-muted fw-semibold mb-1">Experience</p>
                        <p class="mb-0 text-muted">{{ profile.experience|truncatechars:220 }}</p>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
              <h3 class="h5 mb-2">No candidates match your filters yet</h3>
              <p class="text-muted mb-0">Try expanding your keywords or clearing the work style preference to see more profiles.</p>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Skills Bubble JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const skillInput = document.getElementById('skillInput');
    const skillsChips = document.getElementById('skillsChips');
    const searchForm = document.getElementById('searchForm');

    skillInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            addSkill(this.value.trim());
            this.value = '';
        }
    });

    skillInput.addEventListener('input', function() {
        const value = this.value.trim();
        if (value.endsWith(',')) {
            addSkill(value.slice(0, -1).trim());
            this.value = '';
        }
    });

    skillInput.addEventListener('change', function() {
        if (this.value) {
            addSkill(this.value.trim());
            this.value = '';
        }
    });

    function addSkill(skill) {
        if (!skill) return;
        
        const existingSkills = Array.from(skillsChips.querySelectorAll('input[name="skill"]')).map(input => input.value);
        if (existingSkills.includes(skill)) return;

        const chip = document.createElement('span');
        chip.className = 'badge bg-primary d-flex align-items-center gap-2 skill-chip';
        chip.style.fontSize = '0.9rem';
        chip.style.padding = '0.5rem 0.75rem';
        chip.innerHTML = `
            ${skill}
            <input type="hidden" name="skill" value="${skill}">
            <span class="remove-chip" onclick="removeSkill(this)" style="cursor: pointer; font-size: 1.2rem; font-weight: 300; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">×</span>
        `;
        skillsChips.appendChild(chip);
        
        searchForm.submit();
    }
});

function removeSkill(button) {
    button.closest('.skill-chip').remove();
    document.getElementById('searchForm').submit();
}
</script>

<style>
.skill-chip {
    cursor: default;
}

.skill-chip .btn-close {
    cursor: pointer;
}

.skill-chip .btn-close:hover {
    opacity: 1;
}
</style>
{% endblock content %}
