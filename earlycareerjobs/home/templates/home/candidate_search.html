{% extends 'base.html' %}
{% load static %}
{% block content %}
<section class="py-4">
  <div class="container">
    <div class="row g-4">
      <div class="col-12 col-lg-4 col-xl-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <h4 class="h5 mb-3">Search candidates</h4>
            <form method="get" id="searchForm" novalidate>
              <!-- Job Selection (if recruiter has multiple jobs) -->
              {% if recruiter_jobs %}
              <div class="mb-3">
                <label class="form-label">Select Job (optional)</label>
                <select name="job_id" class="form-control" onchange="this.form.submit()">
                  <option value="">All candidates</option>
                  {% for rjob in recruiter_jobs %}
                    <option value="{{ rjob.id }}" {% if job and job.id == rjob.id %}selected{% endif %}>
                      {{ rjob.title }} ({{ rjob.applicant_count }} applicant{{ rjob.applicant_count|pluralize }})
                    </option>
                  {% endfor %}
                </select>
                <small class="text-muted">Select a job to see its candidates.</small>
              </div>
              {% endif %}
              
              <!-- Skills Bubble Input -->
              <div class="mb-3">
                <label class="form-label">Skills</label>
                <input list="skillSuggestions" class="form-control datalist-no-arrow" placeholder="Enter or Select Skills" id="skillInput" autocomplete="off" style="width: 100%;">
                <datalist id="skillSuggestions">
                  {% for skill in all_skills %}
                    <option value="{{ skill }}">
                  {% endfor %}
                </datalist>
                
                <!-- Skills Chips -->
                <div id="skillsChips" class="mt-2 d-flex flex-wrap gap-2">
                  {% for skill in active_skills %}
                    <span class="skill-badge d-flex align-items-center gap-1 skill-chip" style="height: 2rem;">
                      {{ skill }}&nbsp;
                      <input type="hidden" name="skill" value="{{ skill }}">
                      <span class="remove-chip" onclick="removeSkill(this)" 
                            style="cursor: pointer; font-size: 1.2rem; font-weight: 300; opacity: 0.8; transition: opacity 0.2s;" 
                            onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">×</span>
                    </span>
                  {% endfor %}
                </div>
              </div>
              
              <div class="mb-3">
                {{ form.skills_mode.label_tag }}
                {{ form.skills_mode }}
              </div>
              
              <div class="mb-3">
                {{ form.experience.label_tag }}
                {{ form.experience }}
              </div>
              
              <div class="mb-3">
                {{ form.location.label_tag }}
                {{ form.location }}
              </div>
              
              <div class="mb-3">
                {{ form.distance.label_tag }}
                {{ form.distance }}
              </div>
              
              <div class="mb-3">
                {{ form.work_style.label_tag }}
                {{ form.work_style }}
              </div>
              <div class="mb-3">
                {{ form.sort_by.label_tag }}
                {{ form.sort_by }}
              </div>
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary" style="background-color: #5D61EA; border-color: #5D61EA;">Search</button>
                <a href="{% url 'candidates.search' %}" class="btn btn-outline-secondary">Reset</a>
                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#saveSearchModal">
                  <i class="bi bi-bookmark-plus"></i> Save Search
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-8 col-xl-9">
        {% if job %}
          <div class="alert alert-info mb-4">
            <h5 class="mb-2"><i class="bi bi-briefcase"></i> Searching candidates for: {{ job.title }}</h5>
            
            <p class="mb-1"><strong>Location:</strong> 
              {% if job.city %}{{ job.city }}{% endif %}{% if job.state %}{% if job.city %}, {% endif %}{{ job.state }}{% endif %}{% if job.country %}{% if job.city or job.state %}, {% endif %}{{ job.country }}{% endif %}
            </p>
            <p class="mb-0"><small class="text-muted">Distances shown are from the job location to each candidate.</small></p>
          </div>
        {% endif %}
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <p class="text-uppercase small fw-semibold text-muted mb-1">Results</p>
            <h2 class="h4 mb-0">{{ result_count }} {% if result_count == 1 %}candidate{% else %}candidates{% endif %} found</h2>
          </div>
        </div>
        {% if profiles %}
          <div class="row g-4">
            {% for profile in profiles %}
              {% if request.user.is_recruiter and profile.privacy.is_profile_visible == False %}
              {% else %}
                <div class="col-12" style="margin-bottom: 0.5rem;">
                  <div class="card border-1 shadow-sm h-100">
                    <div class="card-body">
                      <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
                        <div>
                          <h3 class="h5 mb-1">
                            <a href="{% url 'profile.view' username=profile.user.username %}" class="text-decoration-none text-dark">
                              {{ profile.user.get_full_name|default:profile.user.username }}
                            </a>
                          </h3>
                          {% if profile.headline %}
                            <p class="mb-2 text-muted">{{ profile.headline }}</p>
                          {% endif %}

                          
                          <div class="mb-2">
                            {% if request.user.is_recruiter and profile.privacy.show_location == False %}
                            {% else %}
                              {% if profile.city or profile.state or profile.country %}
                                <span class="badge text-bg-light border">
                                  <i class="bi bi-geo-alt"></i>
                                  {% if profile.city %}{{ profile.city }}{% endif %}{% if profile.state %}{% if profile.city %}, {% endif %}{{ profile.state }}{% endif %}{% if profile.country %}{% if profile.city or profile.state %}, {% endif %}{{ profile.country }}{% endif %}
                                </span>
                              {% endif %}
                              {% if profile.distance is not None %}
                                <span class="badge bg-info text-dark">{{ profile.distance }} miles away</span>
                              {% endif %}
                            {% endif %}

                            {% if request.user.is_recruiter and profile.privacy.show_work_style_preference == False %}
                            {% elif profile.work_style_preference %}
                              <span class="badge text-bg-light border">{{ profile.get_work_style_preference_display }}</span>
                            {% endif %}
                          </div>
                        

                        </div>
                        <div class="text-md-end">
                          <a href="{% url 'profile.view' username=profile.user.username %}" class="btn btn-outline-primary">
                            View profile
                          </a>
                        </div>
                      </div>

                      {% if request.user.is_recruiter and profile.privacy.show_skills == False %}
                      {% elif profile.skill_list %}
                        <div class="mt-3">
                          <p class="small text-uppercase text-muted fw-semibold mb-2">Skills</p>
                          <div class="skill-badge-group">
                            {% for skill in profile.skill_list %}
                              <span class="skill-badge">{{ skill }}</span>
                            {% endfor %}
                          </div>
                        </div>
                      {% endif %}

                      {% if request.user.is_recruiter and profile.privacy.show_experience == False %}
                      {% elif profile.experience %}
                        <div class="mt-3">
                          <p class="small text-uppercase text-muted fw-semibold mb-1">Experience</p>
                          <p class="mb-0 text-muted">{{ profile.experience|truncatechars:220 }}</p>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
              <h3 class="h5 mb-2">No candidates match your filters yet</h3>
              <p class="text-muted mb-0">Try expanding your keywords or clearing the work style preference to see more profiles.</p>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Save Search Modal -->
<div class="modal fade" id="saveSearchModal" tabindex="-1" aria-labelledby="saveSearchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="saveSearchModalLabel">Save Candidate Search</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        {% csrf_token %}
        <div class="modal-body">
          <p>You are about to save the current search filters. You can receive notifications when new candidates match these criteria.</p>
          
          <div class="card bg-light mb-3">
            <div class="card-body">
              <h6 class="card-title">Current Search Filters:</h6>
              <ul class="mb-0" style="font-size: 0.9rem;">
                {% if current_filters.skills %}
                  <li><strong>Skills:</strong> {{ current_filters.skills }} ({{ current_filters.skills_mode }})</li>
                {% endif %}
                {% if current_filters.experience %}
                  <li><strong>Experience:</strong> {{ current_filters.experience }}</li>
                {% endif %}
                {% if current_filters.location %}
                  <li><strong>Location:</strong> {{ current_filters.location }} within {{ current_filters.distance }} miles</li>
                {% endif %}
                {% if current_filters.work_style %}
                  <li><strong>Work Style:</strong> {{ current_filters.work_style }}</li>
                {% endif %}
                {% if not current_filters.skills and not current_filters.experience and not current_filters.location and not current_filters.work_style %}
                  <li><em>No filters applied (all candidates)</em></li>
                {% endif %}
              </ul>
            </div>
          </div>
          
          {% for field in saved_search_form.hidden_fields %}
            {{ field }}
          {% endfor %}

          <div class="mb-3">
            <label for="id_name" class="form-label">Search Name</label>
            {{ saved_search_form.name }}
            <div class="form-text">Give this search a memorable name (e.g., "Senior Python Devs in SF").</div>
          </div>

          <div class="form-check">
            {{ saved_search_form.is_notification_active }}
            <label class="form-check-label" for="{{ saved_search_form.is_notification_active.id_for_label }}">
              {{ saved_search_form.is_notification_active.label }}
            </label>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" name="save_search" class="btn btn-primary">Save Search</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Hidden form to populate modal fields -->
<form id="hidden-filter-form">
    <input type="hidden" name="experience" value="{{ current_filters.experience|default:'' }}">
    <input type="hidden" name="skills" value="{{ current_filters.skills|default:'' }}">
    <input type="hidden" name="skills_mode" value="{{ current_filters.skills_mode|default:'OR' }}">
    <input type="hidden" name="location" value="{{ current_filters.location|default:'' }}">
    <input type="hidden" name="distance" value="{{ current_filters.distance|default:50 }}">
    <input type="hidden" name="work_style" value="{{ current_filters.work_style|default:'' }}">
</form>

<!-- Skills Bubble JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const skillInput = document.getElementById('skillInput');
    const skillsChips = document.getElementById('skillsChips');
    const searchForm = document.getElementById('searchForm');
    const saveSearchModal = document.getElementById('saveSearchModal');

    saveSearchModal.addEventListener('show.bs.modal', function () {
        // Populate the hidden fields in the modal form with the current filter values
        document.querySelector('#saveSearchModal input[name="experience"]').value = document.querySelector('#hidden-filter-form input[name="experience"]').value;
        document.querySelector('#saveSearchModal input[name="skills"]').value = document.querySelector('#hidden-filter-form input[name="skills"]').value;
        document.querySelector('#saveSearchModal input[name="skills_mode"]').value = document.querySelector('#hidden-filter-form input[name="skills_mode"]').value;
        document.querySelector('#saveSearchModal input[name="location"]').value = document.querySelector('#hidden-filter-form input[name="location"]').value;
        document.querySelector('#saveSearchModal input[name="distance"]').value = document.querySelector('#hidden-filter-form input[name="distance"]').value;
        document.querySelector('#saveSearchModal input[name="work_style"]').value = document.querySelector('#hidden-filter-form input[name="work_style"]').value;
    });

    skillInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            addSkill(this.value.trim());
            this.value = '';
        }
    });

    skillInput.addEventListener('input', function() {
        const value = this.value.trim();
        if (value.endsWith(',')) {
            addSkill(value.slice(0, -1).trim());
            this.value = '';
        }
    });

    skillInput.addEventListener('change', function() {
        if (this.value) {
            addSkill(this.value.trim());
            this.value = '';
        }
    });

    function addSkill(skill) {
        if (!skill) return;
        
        const existingSkills = Array.from(skillsChips.querySelectorAll('input[name="skill"]')).map(input => input.value);
        if (existingSkills.includes(skill)) return;

        const chip = document.createElement('span');
        chip.className = 'skill-badge d-flex align-items-center gap-1 skill-chip';
        chip.style.fontSize = '0.9rem';
        chip.style.padding = '0.5rem 0.75rem';
        chip.style.height = '2rem';
        chip.innerHTML = `
            ${skill}&nbsp;
            <input type="hidden" name="skill" value="${skill}">
            <span class="remove-chip" onclick="removeSkill(this)" style="cursor: pointer; font-size: 1.2rem; font-weight: 300; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">×</span>
        `;
        skillsChips.appendChild(chip);
        
        // searchForm.submit();
    }
});

function removeSkill(button) {
    button.closest('.skill-chip').remove();
    // document.getElementById('searchForm').submit();
}
</script>

<style>
.skill-chip {
    cursor: default;
}

.skill-chip .btn-close {
    cursor: pointer;
}

.skill-chip .btn-close:hover {
    opacity: 1;
}
</style>
{% endblock content %}
